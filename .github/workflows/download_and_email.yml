name: '手动下载并发送链接 (绕过附件限制)'

on:
  workflow_dispatch:
    inputs:
      download_url:
        description: '⬇️ 文件下载 URL'
        required: true
        default: 'https://example.com/file_to_download'
      recipient_email:
        description: '📧 接收下载链接的邮箱地址'
        required: true
        default: 'yaojiwei5201@gmail.com' 

jobs:
  download_and_upload:
    name: '下载并上传到 Artifact'
    runs-on: ubuntu-latest
    
    # 定义环境变量
    env:
      AUTO_FILE_NAME: downloaded_artifact_${{ github.run_id }}.bin
      
    outputs:
      artifact_name: ${{ steps.upload.outputs.artifact-name }}

    steps:
      # 步骤 1: 下载文件
      - name: 1. 下载文件
        id: download
        run: |
          echo "准备从 ${{ github.event.inputs.download_url }} 下载..."
          curl -L -o "${{ env.AUTO_FILE_NAME }}" "${{ github.event.inputs.download_url }}"
          
          # 检查文件大小，如果过小可能是下载失败，但这里假设成功
          echo "文件下载完成，准备上传。"

      # 步骤 2: 将文件上传为 GitHub Artifacts
      - name: 2. 上传文件到 GitHub Artifacts
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.AUTO_FILE_NAME }} # Artifact 的名称
          path: ${{ env.AUTO_FILE_NAME }} # 文件路径
          retention-days: 7 # 文件保留 7 天
          
      # 步骤 3: 清理本地下载的文件
      - name: 3. 清理工作区文件
        if: always() 
        run: rm -f "${{ env.AUTO_FILE_NAME }}"

  send_email_with_link:
    name: '发送下载链接邮件'
    runs-on: ubuntu-latest
    needs: download_and_upload # 依赖上一个 Job 完成
    
    # 定义 Artifact 下载链接的基础 URL
    env:
      ARTIFACT_URL: 'https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'

    steps:
      - name: 1. 发送邮件（包含 Artifact 链接）
        uses: dawidd6/action-send-mail@v3
        with:
          # SMTP 配置 (使用 Secrets)
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }} 

          # 邮件内容
          subject: '✅ GitHub Actions 下载任务完成：下载链接已准备'
          to: ${{ github.event.inputs.recipient_email }}
          from: GitHub Actions <${{ secrets.SMTP_USERNAME }}> 
          
          body: |
            您在 GitHub Actions 触发的下载任务已完成。
            
            **文件已上传到 GitHub Artifacts。**
            
            目标邮箱: ${{ github.event.inputs.recipient_email }}
            原始下载源: ${{ github.event.inputs.download_url }}
            Artifact 文件名: ${{ needs.download_and_upload.outputs.artifact_name }}
            
            请点击下方链接查看/下载文件：
            
            [点击下载 Artifact 文件](${{ env.ARTIFACT_URL }})
            
            **注意：** 您需要登录 GitHub 才能下载 Artifact。Artifact 文件将在 7 天后自动删除。
