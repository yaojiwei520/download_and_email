name: 'æ‰‹åŠ¨ä¸‹è½½æ–‡ä»¶å¹¶ä½œä¸ºé™„ä»¶å‘é€'

on:
  workflow_dispatch:
    inputs:
      download_url:
        description: 'â¬‡ï¸ æ–‡ä»¶ä¸‹è½½ URL'
        required: true
        default: 'https://example.com/file_to_download'
      recipient_email:
        description: 'ğŸ“§ æ¥æ”¶æ–‡ä»¶çš„é‚®ç®±åœ°å€'
        required: true
        default: '275559292@qq.com' 

jobs:
  download_and_send_email:
    name: 'ä¸‹è½½å¹¶å‘é€ä»»åŠ¡'
    runs-on: ubuntu-latest

    # å®šä¹‰ç¯å¢ƒå˜é‡æ¥å­˜å‚¨è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶å
    env:
      AUTO_FILE_NAME: downloaded_artifact_${{ github.run_id }} # ä¸åŠ åç¼€ï¼Œç¡®ä¿å…¼å®¹æ€§

    steps:
      # æ­¥éª¤ 1: ä¸‹è½½æ–‡ä»¶ (ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶å)
      - name: 1. ä¸‹è½½æ–‡ä»¶
        run: |
          echo "å‡†å¤‡ä» ${{ github.event.inputs.download_url }} ä¸‹è½½..."
          # ä¸‹è½½æ–‡ä»¶åˆ°å·¥ä½œåŒºï¼Œä¸åŠ åç¼€å
          curl -L -o "${{ env.AUTO_FILE_NAME }}" "${{ github.event.inputs.download_url }}"
          
          echo "æ–‡ä»¶ä¸‹è½½å®Œæˆ!"
          echo "è‡ªåŠ¨æ–‡ä»¶å: ${{ env.AUTO_FILE_NAME }}"

      # æ­¥éª¤ 2: å‘é€é‚®ä»¶ï¼ˆå¸¦é™„ä»¶ï¼‰
      - name: 2. å‘é€é‚®ä»¶
        uses: dawidd6/action-send-mail@v3
        with:
          # SMTP æœåŠ¡å™¨é…ç½®
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }} 

          # é‚®ä»¶å†…å®¹é…ç½®
          subject: 'âœ… æ–‡ä»¶é™„ä»¶å·²å‘é€: ${{ env.AUTO_FILE_NAME }}'
          to: ${{ github.event.inputs.recipient_email }}
          from: GitHub Actions <${{ secrets.SMTP_USERNAME }}> 
          
          body: |
            æ‚¨è¯·æ±‚çš„æ–‡ä»¶å·²é€šè¿‡é™„ä»¶å‘é€ã€‚
            é™„ä»¶å: ${{ env.AUTO_FILE_NAME }}
            
          # é™„ä»¶åŠŸèƒ½ï¼ˆæŒ‡å‘ä¸‹è½½çš„æ–‡ä»¶ï¼‰
          attachments: ./${{ env.AUTO_FILE_NAME }}
          
      # æ­¥éª¤ 3: æ¸…ç†ä¸‹è½½çš„æ–‡ä»¶
      - name: 3. æ¸…ç†å·¥ä½œåŒºæ–‡ä»¶
        if: always() 
        run: |
          echo "æ¸…ç†ä¸‹è½½çš„æ–‡ä»¶..."
          rm -f "${{ env.AUTO_FILE_NAME }}"
          echo "æ¸…ç†å®Œæˆã€‚"
