name: 'æ‰‹åŠ¨ä¸‹è½½å¹¶å‘é€é“¾æ¥ (ç»•è¿‡é™„ä»¶é™åˆ¶)'

on:
  workflow_dispatch:
    inputs:
      download_url:
        description: 'â¬‡ï¸ æ–‡ä»¶ä¸‹è½½ URL'
        required: true
        default: 'https://example.com/file_to_download'
      recipient_email:
        description: 'ğŸ“§ æ¥æ”¶ä¸‹è½½é“¾æ¥çš„é‚®ç®±åœ°å€'
        required: true
        default: 'yaojiwei5201@gmail.com' 

jobs:
  download_and_upload:
    name: 'ä¸‹è½½å¹¶ä¸Šä¼ åˆ° Artifact'
    runs-on: ubuntu-latest
    
    # å®šä¹‰ç¯å¢ƒå˜é‡
    env:
      AUTO_FILE_NAME: downloaded_artifact_${{ github.run_id }}.bin
      
    outputs:
      artifact_name: ${{ steps.upload.outputs.artifact-name }}

    steps:
      # æ­¥éª¤ 1: ä¸‹è½½æ–‡ä»¶
      - name: 1. ä¸‹è½½æ–‡ä»¶
        id: download
        run: |
          echo "å‡†å¤‡ä» ${{ github.event.inputs.download_url }} ä¸‹è½½..."
          curl -L -o "${{ env.AUTO_FILE_NAME }}" "${{ github.event.inputs.download_url }}"
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼Œå¦‚æœè¿‡å°å¯èƒ½æ˜¯ä¸‹è½½å¤±è´¥ï¼Œä½†è¿™é‡Œå‡è®¾æˆåŠŸ
          echo "æ–‡ä»¶ä¸‹è½½å®Œæˆï¼Œå‡†å¤‡ä¸Šä¼ ã€‚"

      # æ­¥éª¤ 2: å°†æ–‡ä»¶ä¸Šä¼ ä¸º GitHub Artifacts
      - name: 2. ä¸Šä¼ æ–‡ä»¶åˆ° GitHub Artifacts
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.AUTO_FILE_NAME }} # Artifact çš„åç§°
          path: ${{ env.AUTO_FILE_NAME }} # æ–‡ä»¶è·¯å¾„
          retention-days: 7 # æ–‡ä»¶ä¿ç•™ 7 å¤©
          
      # æ­¥éª¤ 3: æ¸…ç†æœ¬åœ°ä¸‹è½½çš„æ–‡ä»¶
      - name: 3. æ¸…ç†å·¥ä½œåŒºæ–‡ä»¶
        if: always() 
        run: rm -f "${{ env.AUTO_FILE_NAME }}"

  send_email_with_link:
    name: 'å‘é€ä¸‹è½½é“¾æ¥é‚®ä»¶'
    runs-on: ubuntu-latest
    needs: download_and_upload # ä¾èµ–ä¸Šä¸€ä¸ª Job å®Œæˆ
    
    # å®šä¹‰ Artifact ä¸‹è½½é“¾æ¥çš„åŸºç¡€ URL
    env:
      ARTIFACT_URL: 'https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'

    steps:
      - name: 1. å‘é€é‚®ä»¶ï¼ˆåŒ…å« Artifact é“¾æ¥ï¼‰
        uses: dawidd6/action-send-mail@v3
        with:
          # SMTP é…ç½® (ä½¿ç”¨ Secrets)
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }} 

          # é‚®ä»¶å†…å®¹
          subject: 'âœ… GitHub Actions ä¸‹è½½ä»»åŠ¡å®Œæˆï¼šä¸‹è½½é“¾æ¥å·²å‡†å¤‡'
          to: ${{ github.event.inputs.recipient_email }}
          from: GitHub Actions <${{ secrets.SMTP_USERNAME }}> 
          
          body: |
            æ‚¨åœ¨ GitHub Actions è§¦å‘çš„ä¸‹è½½ä»»åŠ¡å·²å®Œæˆã€‚
            
            **æ–‡ä»¶å·²ä¸Šä¼ åˆ° GitHub Artifactsã€‚**
            
            ç›®æ ‡é‚®ç®±: ${{ github.event.inputs.recipient_email }}
            åŸå§‹ä¸‹è½½æº: ${{ github.event.inputs.download_url }}
            Artifact æ–‡ä»¶å: ${{ needs.download_and_upload.outputs.artifact_name }}
            
            è¯·ç‚¹å‡»ä¸‹æ–¹é“¾æ¥æŸ¥çœ‹/ä¸‹è½½æ–‡ä»¶ï¼š
            
            [ç‚¹å‡»ä¸‹è½½ Artifact æ–‡ä»¶](${{ env.ARTIFACT_URL }})
            
            **æ³¨æ„ï¼š** æ‚¨éœ€è¦ç™»å½• GitHub æ‰èƒ½ä¸‹è½½ Artifactã€‚Artifact æ–‡ä»¶å°†åœ¨ 7 å¤©åè‡ªåŠ¨åˆ é™¤ã€‚
